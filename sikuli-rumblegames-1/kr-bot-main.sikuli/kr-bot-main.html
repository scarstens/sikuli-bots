
<html>
   <head>
      <style type="text/css">
         .sikuli-code {
            font-size: 20px;
            font-family: "Osaka-mono", Monospace;
            line-height: 1.5em;
            display:table-cell;
            white-space: pre-wrap;       /* css-3 */
            white-space: -moz-pre-wrap !important;  /* Mozilla, since 1999 */
            white-space: -pre-wrap;      /* Opera 4-6 */
            white-space: -o-pre-wrap;    /* Opera 7 */
            word-wrap: break-word;       /* Internet Explorer 5.5+ */
            width: 99%;   /* remove horizontal scroll-bar when viewing in IE7 */
         }
         .sikuli-code img {
            vertical-align: middle;
            margin: 2px;
            border: 1px solid #ccc;
            padding: 2px;
            -moz-border-radius: 5px;
            -webkit-border-radius: 5px;
            -moz-box-shadow: 1px 1px 1px gray;
            -webkit-box-shadow: 1px 1px 2px gray;
         }
         .kw {
            color: blue;
         }
         .skw {
            color: rgb(63, 127, 127);
         }

         .str {
            color: rgb(128, 0, 0);
         }

         .dig {
            color: rgb(128, 64, 0);
         }

         .cmt {
            color: rgb(200, 0, 200);
         }

         h2 {
            display: inline;
            font-weight: normal;
         }

         .info {
            border-bottom: 1px solid #ddd;
            padding-bottom: 5px;
            margin-bottom: 20px;
            display: none;
         }

         a {
            color: #9D2900;
         }

         body {
            font-family: "Trebuchet MS", Arial, Sans-Serif;
         }

      </style>
   </head>
<body>
<div class="info">
<h2>kr-bot-main.sikuli</h2> <a href="kr-bot-main.zip">(Download this script)</a>
</div>
<pre class="sikuli-code">
<span class="cmt"># TODO:</span>
<span class="cmt"># OPEN LOCKBOXES: http://doc.sikuli.org/finder.html?highlight=rows</span>


<span class="cmt"># Global Settings to start with - these can be changed later</span>
Settings.MoveMouseDelay = <span class="dig">0.5</span> <span class="cmt"># default 2 times a second</span>
Settings.ObserveScanRate = <span class="dig">0.333</span> <span class="cmt"># default 3 times a second</span>
Settings.DelayBeforeMouseDown = <span class="dig">0.5</span> <span class="cmt"># only applies to next click</span>
setShowActions(True)
<span class="cmt">#setFindFailedResponse(PROMPT) # try forver on fail - doesn't seem to play nice right now</span>

<span class="cmt"># define globals</span>
debug_popups = False
running = True
game_available = True
logged_in = True
auto_run_loop = False
auto_run_count = <span class="dig">0</span>
fail_to_run = <span class="dig">0</span>
map_to_run = <span class="dig">0</span>
map_mode_to_run = <span class="dig">2</span>
continue_run = True


<span class="cmt">#define regions (as of version 0.0.4 loaded dynamically)</span>
rgn_game = Screen
rgn_top_bar = Screen
rgn_top_left = Screen
rgn_top_right = Screen

<span class="cmt"># define images</span>
img_game_icon = <img src="img_game_icon.png" />
img_play = <img src="img_play.png" />
img_refresh = Pattern(<img src="img_refresh.png" />).similar(<span class="dig">0.80</span>)
img_toclose = <img src="img_toclose.png" />
img_toclose_2 = <img src="img_toclose_2.png" />
img_yesconfirm = Pattern(<img src="img_yesconfirm.png" />).similar(<span class="dig">0.85</span>)
img_gem = Pattern(<img src="img_gem.png" />).similar(<span class="dig">0.85</span>)
img_town_statue_arm = Pattern(<img src="img_town_statue_arm.png" />).similar(<span class="dig">0.80</span>)
img_town_window = <img src="img_town_window.png" />
img_mana_bar = <img src="img_mana_bar.png" />
img_zoomout = Pattern(<img src="img_zoomout.png" />).similar(<span class="dig">0.95</span>)
img_goldbonus = Pattern(<img src="img_goldbonus.png" />).similar(<span class="dig">0.40</span>)
img_declineinvite = <img src="img_declineinvite.png" />
img_accept = <img src="img_accept.png" />
img_playalone = <img src="img_playalone.png" />
img_auto = Pattern(<img src="img_autoplay.png" />).similar(<span class="dig">0.85</span>)
img_free = <img src="img_free.png" />
img_acheivements = <img src="img_acheivements.png" />
img_end_level = <img src="img_end_level.png" />
img_boss_drops = Pattern(<img src="img_boss_drops.png" />).similar(<span class="dig">0.50</span>).targetOffset(-<span class="dig">46</span>,<span class="dig">7</span>)
img_return_to_town = <img src="img_return_to_town.png" />

<span class="cmt"># image collections</span>


collection_maps = (<img src="adamars_sanctum.png" />,<img src="inner_circle.png" />,<img src="battlements.png" />)
collection_maps_2 = (Pattern(<img src="maps_2_adamarssanctum.png" />).similar(<span class="dig">0.50</span>),<img src="map_2_innercircle.png" />, <img src="map_2_snake.png" />)
collection_npcs = (Pattern(<img src="npc_world.png" />).targetOffset(-<span class="dig">3</span>,<span class="dig">23</span>),Pattern(<img src="npc_helm.png" />).targetOffset(-<span class="dig">2</span>,<span class="dig">29</span>),Pattern(<img src="npc_dungeon-1.png" />).targetOffset(<span class="dig">1</span>,-<span class="dig">70</span>),Pattern(<img src="npc_swords.png" />).targetOffset(<span class="dig">0</span>,<span class="dig">27</span>),)
collection_modes = (<img src="mode_normal.png" />,<img src="mode_heroic.png" />,<img src="mode_champion.png" />)
collection_lockboxes = (<img src="lockbox_bossdrop.png" />,<img src="lockbox_dragon_blue.png" />,<img src="lockbox_prism.png" />,<img src="lockbox_skillrune.png" />,<img src="lockbox_heroessence.png" />,Pattern(<img src="locbox_xp.png" />).similar(<span class="dig">0.80</span>),<img src="lockbox_tournament.png" />,<img src="lockbox_tournament_2.png" />)
collection_tournament_modes = (<img src="tournament_mode_bronze.png" />,<img src="tournament_mode_silver.png" />,<img src="tournament_mode_gold.png" />)

<span class="cmt"># setting ctrl+space as a hotkey to tell the bot to quit gracefully at will</span>
<span class="kw">def</span> runHotKey(event):
    <span class="kw">global</span> running
    running = False
Env.addHotkey(Key.SPACE, KeyModifier.CTRL, runHotKey)

<span class="cmt"># slow left mouse click</span>
<span class="kw">def</span> left_mouse_click():
    mouseDown(Button.LEFT)
    <span class="skw">sleep</span>(<span class="dig">0.3</span>)
    mouseUp(Button.LEFT)

<span class="cmt"># used to make sure popups only run when popups are enabled</span>
<span class="kw">def</span> notify(message):
    <span class="kw">if</span> debug_popups <span class="kw">and</span> message:
        <span class="skw">popup</span>(message)

<span class="cmt"># detects if the game is still open based on window title</span>
<span class="kw">def</span> isGameOpen():
    <span class="kw">global</span> game, game_available
    game = App(<span class="str">'KingsRoad'</span>)
    switchApp(game)
    game_available = game.hasWindow()
    notify(game.getWindow())
    <span class="kw">return</span> game_available

<span class="cmt"># Unused currently, but needs to check on the flash area and confirm flash didn't crash / stop working</span>
<span class="kw">def</span> isFlashWorking():
    <span class="kw">return</span> exists(img_game_icon)
    <span class="skw">sleep</span>(<span class="dig">1</span>)

<span class="cmt"># This thing is pretty slow, need a different way to check if logged in</span>
<span class="kw">def</span> maybeLogin():
    <span class="kw">global</span> logged_in
    <span class="kw">if</span> exists(img_play, <span class="dig">1</span>):
        <span class="skw">click</span>(img_play)
        logged_in = True
        <span class="skw">sleep</span>(<span class="dig">3</span>)
        <span class="kw">return</span> True
    <span class="kw">elif</span> exists(img_refresh, <span class="dig">1</span>):
        hover(img_refresh)
        left_mouse_click()
        logged_in = True
        <span class="skw">sleep</span>(<span class="dig">2</span>)
        <span class="kw">return</span> True
    <span class="kw">return</span> False

<span class="kw">def</span> maybeClosePopups():
    <span class="kw">if</span> exists(img_toclose):
        <span class="skw">click</span>(img_toclose)
        <span class="skw">sleep</span>(<span class="dig">1</span>)
        <span class="kw">if</span> exists(img_yesconfirm):
            <span class="skw">click</span>(img_yesconfirm)
            <span class="skw">sleep</span>(<span class="dig">1</span>)
        <span class="cmt"># return continue as true, we found one and there may be another</span>
        <span class="kw">return</span> True
    <span class="kw">else</span>:
        <span class="cmt"># return continue as false, we are done</span>
        <span class="kw">return</span> False

<span class="kw">def</span> closeAllPopups():
    <span class="kw">global</span> running
    <span class="kw">while</span> ( running <span class="kw">and</span> maybeClosePopups() ):
        <span class="skw">sleep</span>(<span class="dig">0.1</span>)
        notify(<span class="str">'closed another popup...'</span>)

<span class="kw">def</span> moveToMapNPC():
    <span class="kw">global</span> continue_run
    <span class="kw">if</span> exists( img_gem ):
        hover( Pattern(img_gem).targetOffset(<span class="dig">5</span>,<span class="dig">50</span>) )
        mouseDown(Button.RIGHT)
        <span class="skw">sleep</span>(<span class="dig">2</span>)
        mouseUp(Button.RIGHT)
    <span class="kw">if</span> exists( img_town_statue_arm ):
        hover( Pattern(img_town_statue_arm).targetOffset(-<span class="dig">110</span>,<span class="dig">0</span>) )
        mouseDown(Button.LEFT)
        <span class="skw">sleep</span>(<span class="dig">2</span>)
        mouseUp(Button.LEFT)
        <span class="kw">return</span> True
    <span class="kw">elif</span> exists( img_town_window ):
        hover ( Pattern(img_mana_bar).targetOffset(<span class="dig">0</span>,-<span class="dig">24</span>) )
        mouseDown(Button.RIGHT)
        <span class="skw">sleep</span>(<span class="dig">2</span>)
        mouseUp(Button.RIGHT)
        <span class="kw">if</span> exists( img_gem ):
            hover( Pattern(img_gem).targetOffset(<span class="dig">5</span>,<span class="dig">50</span>) )
            mouseDown(Button.RIGHT)
            <span class="skw">sleep</span>(<span class="dig">2</span>)
            mouseUp(Button.RIGHT)
        <span class="kw">if</span> exists( img_town_statue_arm ):
            hover( Pattern(img_town_statue_arm).targetOffset(-<span class="dig">110</span>,<span class="dig">0</span>) )
            mouseDown(Button.LEFT)
            <span class="skw">sleep</span>(<span class="dig">2</span>)
            mouseUp(Button.LEFT)
            <span class="kw">return</span> True
    <span class="kw">else</span>:
        continue_run = False
    <span class="kw">return</span> False

<span class="kw">def</span> maybeZoomOut():
    <span class="kw">global</span> rgn_top_right
    notify(<span class="str">"Trying to zoom out"</span>)
    <span class="kw">with</span> rgn_top_right:
        <span class="kw">if</span> exists( img_zoomout, <span class="dig">1</span> ):
            <span class="skw">click</span>( img_zoomout )
            notify(<span class="str">"Zoomed out just now."</span>)
            <span class="kw">return</span> True
        notify(<span class="str">"Zoomed out already."</span>)
    <span class="kw">return</span> False

<span class="kw">def</span> chooseMap():
    <span class="kw">global</span> map_to_run
    notify(<span class="str">"Check for map image: "</span> + collection_maps_2[map_to_run].getFilename() )
    <span class="kw">if</span> exists( collection_maps_2[map_to_run] ):
        <span class="skw">click</span>( collection_maps_2[map_to_run] )
        notify(<span class="str">'Whoa, found that map you were looking for ;)'</span>);
    <span class="kw">else</span>:
        notify(<span class="str">'Sigh, maps image recog failed again.'</span>)

<span class="kw">def</span> chooseMode():
    <span class="kw">global</span> continue_run
    <span class="kw">if</span> exists( collection_modes[map_mode_to_run] ):
        <span class="skw">click</span>( collection_modes[map_mode_to_run] )
        <span class="skw">sleep</span>(<span class="dig">0.5</span>)
        notify(<span class="str">'Hey man, I totally clicked on that map for you. Your welcome.'</span>)
        <span class="kw">if</span> exists( img_playalone ):
            <span class="skw">click</span>( img_playalone )
            notify(<span class="str">'Yup, we confirmed playing solo.'</span>)
        <span class="skw">sleep</span>(<span class="dig">2</span>)
        continue_run = True
    <span class="kw">else</span>:
        notify(<span class="str">'Something went wrong during choosing the mode.'</span>)
        continue_run = False
        exit

<span class="kw">def</span> startAutoRun():
    autorunning = False
    <span class="kw">while</span> <span class="kw">not</span> autorunning:
        rgn_auto = <span class="skw">wait</span>( img_auto, <span class="dig">20</span> )
        hover( rgn_auto )
        left_mouse_click()
        hover( rgn_auto.offset(Location(<span class="dig">0</span>, <span class="dig">50</span>)) )
        <span class="skw">sleep</span>(<span class="dig">2</span>)
        autorunning = <span class="kw">not</span> exists( img_auto, <span class="dig">1</span>)
    notify(<span class="str">'Confirmed auto running clicked.'</span>)
    maybeBlessing()

<span class="kw">def</span> maybeBlessing():
    <span class="kw">if</span> exists( img_free ):
        <span class="skw">click</span>( img_free )
    <span class="kw">if</span> exists( img_acheivements ):
        <span class="skw">click</span>( Pattern(img_acheivements).targetOffset(<span class="dig">0</span>,<span class="dig">55</span>) )
    notify(<span class="str">"Blessing and popup closure complete."</span>)

<span class="kw">def</span> waitForEndLevel():
    <span class="kw">global</span> game, continue_run
    notify(<span class="str">"Waiting for end of level now... will try twice then return to town"</span>)
    attempt = <span class="dig">1</span>
    success = False
    <span class="kw">while</span> attempt &lt; <span class="dig">3</span> <span class="kw">and</span> <span class="kw">not</span> success <span class="kw">and</span> <span class="skw">wait</span>( img_end_level, <span class="dig">300</span> ):
        notify(<span class="str">"End of level found, returning to town"</span>)
        <span class="skw">click</span> ( img_end_level )
        <span class="skw">wait</span>( img_return_to_town, <span class="dig">10</span> )
        <span class="cmt">#image starts disabled wait a moment</span>
        <span class="skw">sleep</span>(<span class="dig">1</span>)
        <span class="skw">click</span>( img_return_to_town )
        success = <span class="kw">not</span> exists( img_end_level )
        attempt = attempt + <span class="dig">1</span>
        <span class="kw">return</span> True
    notify(<span class="str">"End of level failed, safest course of action is to refresh."</span>)
    game.close()
    continue_run = False
    <span class="kw">return</span> False

<span class="kw">def</span> setup_game_regions(show = <span class="dig">0</span>):
    <span class="kw">global</span> rgn_game, rgn_top_bar, rgn_top_left, rgn_top_right, rgn_bottom_left, rgn_bottom_right
    <span class="kw">try</span>:
        <span class="skw">wait</span>(img_game_icon, <span class="dig">30</span>)
    <span class="kw">except</span> FindFailed:
        notify(<span class="str">"Never found game region"</span>)
        <span class="kw">return</span> False
    <span class="kw">try</span>:
        icon = <span class="skw">find</span>(img_game_icon)
        rgn_game = Region(icon.x, icon.y+icon.h, icon.right().w,icon.below().h)
        rgn_game.highlight(show)
        hover(rgn_game.getCenter())
        rgn_top_bar = Region(icon.x, icon.y, icon.right().w,icon.h)
        rgn_top_bar.highlight(show)
        rgn_top_left = Region(icon.x, icon.y+icon.h, rgn_game.getCenter().x,rgn_game.getCenter().y-(icon.y+icon.h))
        rgn_top_left.highlight(show)
        rgn_top_right = Region(rgn_game.getCenter().x, icon.y+icon.h, rgn_game.getCenter().x,rgn_game.getCenter().y-(icon.y+icon.h))
        rgn_top_right.highlight(show)
        rgn_bottom_left = Region(icon.x, rgn_game.getCenter().y, rgn_game.getCenter().x,rgn_game.getCenter().y-(icon.y+icon.h))
        rgn_bottom_left.highlight(show)
        rgn_bottom_right = Region(rgn_game.getCenter().x, rgn_game.getCenter().y, rgn_game.getCenter().x,rgn_game.getCenter().y-(icon.y+icon.h))
        rgn_bottom_right.highlight(show)
        <span class="cmt">#hover(rgn_top_bar)</span>
        <span class="kw">return</span> True
    <span class="kw">except</span> FindFailed:
        notify(<span class="str">"Error: Game icon disappeared"</span>)
        <span class="kw">return</span> False

op_play_type = (<span class="str">"autoplay"</span>, <span class="str">"autoplay-notify"</span>, <span class="str">"debug"</span>)
option = select(<span class="str">"Please choose a bot play type"</span>, options = op_play_type);

<span class="cmt"># main constructor (init run)</span>
<span class="kw">while</span>( running ):
    notify(<span class="str">"Running Loop - moving to chosen play type."</span>)
    <span class="kw">if</span> option == op_play_type[<span class="dig">2</span>]:
        setup_game_regions(<span class="dig">0</span>)
        waitForEndLevel()
        option = select(<span class="str">"Please choose a bot play type"</span>, options = op_play_type);
    <span class="kw">else</span>:
        <span class="kw">if</span> option == op_play_type[<span class="dig">1</span>]:
            debug_popups = True
        <span class="kw">if</span> False == isGameOpen():
            notify(<span class="str">"Opening browser, game not found."</span>)
            openApp(<span class="str">r"C:\Program Files\Google\Chrome\Application\chrome.exe https://apps.facebook.com/kingsroadgame/ -start-maximized"</span>)
            logged_in = False
            <span class="skw">sleep</span>(<span class="dig">5</span>)
        <span class="kw">else</span>:
            <span class="cmt"># Reset continue run since we are starting over here </span>
            continue_run = True
            setup_game_regions()
            <span class="kw">if</span> False == logged_in:
                <span class="skw">sleep</span>(<span class="dig">0.1</span>)
                notify(<span class="str">'Not logged in yet :('</span>)
            <span class="kw">if</span> maybeLogin():
                <span class="skw">sleep</span>(<span class="dig">0.1</span>) <span class="cmt">#do anything on login?</span>
            <span class="kw">if</span> logged_in:
                notify(<span class="str">'Found you logged in!'</span>)
                closeAllPopups()
                <span class="kw">if</span>( moveToMapNPC() ):
                    notify(<span class="str">"Phew, found the map dude."</span>)
                    <span class="kw">if</span>( continue_run ):
                        maybeZoomOut()
                    <span class="kw">if</span>( continue_run ):
                        chooseMap()
                    <span class="kw">if</span>( continue_run ):
                        chooseMode()
                    <span class="kw">if</span>( continue_run ):
                        startAutoRun()
                        notify(<span class="str">'Stepping into waitForEndLevel'</span>)
                    <span class="kw">if</span>( continue_run ):
                        notify(<span class="str">"Beginning waitforEndLevel"</span>)
                        waitForEndLevel()
                        notify(<span class="str">"End of waitForEndLevel"</span>)
              <span class="cmt">#end of main loop, starting over</span>
<span class="cmt"># END OF FILE</span>
<span class="skw">popup</span>(<span class="str">"KingsRoad Is Complete!"</span>)
</pre>
</body>
</html>
